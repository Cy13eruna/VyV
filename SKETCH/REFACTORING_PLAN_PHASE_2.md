# üîß REFACTORING PLAN - PHASE 2: BREAKING THE REMAINING MONOLITHS\n\n## üìä CURRENT STATE ANALYSIS\n\n### üîç **MONOLITHIC FILES IDENTIFIED:**\n\n| File | Lines | Functions | Status | Priority |\n|------|-------|-----------|--------|----------|\n| **main_game.gd** | 1517 | 67 | üî¥ CRITICAL | HIGH |\n| **unit_system.gd** | 547 | ~25 | üü° LARGE | HIGH |\n| **game_manager.gd** | 461 | ~20 | üü° LARGE | MEDIUM |\n| **ui_system.gd** | 366 | ~15 | üü† MEDIUM | MEDIUM |\n| **render_system.gd** | 320 | ~12 | üü† MEDIUM | LOW |\n\n**Total**: 3,211 lines of monolithic code\n\n---\n\n## üéØ REFACTORING STRATEGY\n\n### **PHASE 2 OBJECTIVES:**\n1. **Break main_game.gd** into specialized systems\n2. **Modularize remaining systems** into focused components\n3. **Maintain 100% functionality** throughout process\n4. **Create clean, maintainable architecture**\n\n### **GUIDING PRINCIPLES:**\n- ‚úÖ **Single Responsibility Principle**: Each system has one clear purpose\n- ‚úÖ **Loose Coupling**: Systems communicate via signals/interfaces\n- ‚úÖ **High Cohesion**: Related functionality grouped together\n- ‚úÖ **Testability**: Each system can be tested independently\n\n---\n\n## üöÄ IMPLEMENTATION SCHEDULE - PHASE 2\n\n### **STEP 10: Extract VisibilitySystem from main_game.gd (HIGH RISK)**\n**Objective**: Create dedicated visibility and fog-of-war system\n**Target**: ~200 lines reduction\n\n**Functions to extract:**\n- `_is_point_visible_to_unit()`\n- `_is_point_visible_to_current_unit()`\n- `_is_domain_visible()`\n- `_is_point_in_current_player_domain()`\n- `_is_point_in_specific_domain()`\n- `_is_path_in_current_player_domain()`\n\n**Actions:**\n- [ ] Create `systems/visibility_system.gd`\n- [ ] Move fog-of-war logic\n- [ ] Integrate with existing systems\n- [ ] **CRITICAL TEST**: Verify fog of war and visibility\n\n---\n\n### **STEP 11: Extract MovementSystem from main_game.gd (HIGH RISK)**\n**Objective**: Create dedicated movement and pathfinding system\n**Target**: ~150 lines reduction\n\n**Functions to extract:**\n- `_can_current_unit_move_to_point()`\n- `_can_unit_move_to_point()`\n- `_attempt_movement()`\n- `_get_path_type_between_points()`\n- `_handle_movement_fallback()`\n\n**Actions:**\n- [ ] Create `systems/movement_system.gd`\n- [ ] Move movement validation logic\n- [ ] Integrate with UnitSystem\n- [ ] **CRITICAL TEST**: Verify unit movement\n\n---\n\n### **STEP 12: Extract GridSystem from main_game.gd (MEDIUM RISK)**\n**Objective**: Complete hexagonal grid management\n**Target**: ~200 lines reduction\n\n**Functions to extract:**\n- `_generate_hex_grid()`\n- `_hex_to_pixel()`\n- `_hex_direction()`\n- `_generate_hex_paths()`\n- `_find_hex_coord_index()`\n- `_hex_distance()`\n- `_get_map_corners()`\n\n**Actions:**\n- [ ] Enhance existing `HexGridSystem`\n- [ ] Move remaining grid logic\n- [ ] Consolidate coordinate systems\n- [ ] **TEST**: Verify grid generation and coordinates\n\n---\n\n### **STEP 13: Extract DomainSystem from main_game.gd (HIGH RISK)**\n**Objective**: Create dedicated domain management system\n**Target**: ~250 lines reduction\n\n**Functions to extract:**\n- `_draw_domains()`\n- `_draw_domain_hexagon()`\n- `_get_edge_length()`\n- `_generate_domain_and_unit_names()`\n- `_create_name_labels()`\n- `_find_adjacent_six_edge_point()`\n- `_find_best_domain_positions()`\n\n**Actions:**\n- [ ] Create `systems/domain_system.gd`\n- [ ] Move domain creation and rendering\n- [ ] Integrate with PowerSystem\n- [ ] **CRITICAL TEST**: Verify domains and names\n\n---\n\n### **STEP 14: Extract InitializationSystem from main_game.gd (MEDIUM RISK)**\n**Objective**: Clean startup and initialization logic\n**Target**: ~150 lines reduction\n\n**Functions to extract:**\n- `_set_initial_unit_positions_with_system()`\n- `_set_initial_unit_positions()`\n- `_set_initial_unit_positions_fallback()`\n- `_analyze_grid_connectivity()`\n- `_mark_map_corners()`\n\n**Actions:**\n- [ ] Create `systems/initialization_system.gd`\n- [ ] Move startup logic\n- [ ] Coordinate system initialization\n- [ ] **TEST**: Verify game startup\n\n---\n\n### **STEP 15: Refactor UnitSystem (HIGH RISK)**\n**Objective**: Break UnitSystem into focused components\n**Target**: Split into 2-3 smaller systems\n\n**Potential splits:**\n- **UnitMovementSystem**: Movement logic\n- **UnitStateSystem**: Position and action management\n- **UnitInteractionSystem**: Unit-to-unit interactions\n\n**Actions:**\n- [ ] Analyze UnitSystem responsibilities\n- [ ] Create focused sub-systems\n- [ ] Maintain signal communication\n- [ ] **CRITICAL TEST**: Verify all unit functionality\n\n---\n\n### **STEP 16: Refactor GameManager (MEDIUM RISK)**\n**Objective**: Split GameManager into focused coordinators\n**Target**: Split into 2-3 smaller managers\n\n**Potential splits:**\n- **TurnManager**: Turn switching and player management\n- **StateManager**: Game state coordination\n- **EventManager**: Signal coordination between systems\n\n**Actions:**\n- [ ] Analyze GameManager responsibilities\n- [ ] Create focused managers\n- [ ] Maintain coordination capabilities\n- [ ] **TEST**: Verify game flow\n\n---\n\n### **STEP 17: Refactor UISystem (LOW RISK)**\n**Objective**: Split UI into logical components\n**Target**: Split into 2-3 UI managers\n\n**Potential splits:**\n- **LabelManager**: All label management\n- **ButtonManager**: Button and input UI\n- **HUDManager**: Game HUD and status display\n\n**Actions:**\n- [ ] Analyze UI responsibilities\n- [ ] Create focused UI managers\n- [ ] Maintain UI consistency\n- [ ] **TEST**: Verify all UI elements\n\n---\n\n### **STEP 18: Refactor RenderSystem (LOW RISK)**\n**Objective**: Split rendering into specialized renderers\n**Target**: Split into 2-3 render components\n\n**Potential splits:**\n- **GridRenderer**: Grid and path rendering\n- **UnitRenderer**: Unit and label rendering\n- **EffectRenderer**: Visual effects and highlights\n\n**Actions:**\n- [ ] Analyze rendering responsibilities\n- [ ] Create focused renderers\n- [ ] Maintain visual consistency\n- [ ] **TEST**: Verify all rendering\n\n---\n\n### **STEP 19: Create main_game.gd as Pure Coordinator (FINAL)**\n**Objective**: Reduce main_game.gd to minimal coordinator\n**Target**: <200 lines, pure coordination\n\n**Final main_game.gd should only:**\n- Initialize systems\n- Coordinate high-level game flow\n- Handle Godot lifecycle (_ready, _process, _draw)\n- Route signals between systems\n\n**Actions:**\n- [ ] Move all remaining logic to appropriate systems\n- [ ] Keep only coordination code\n- [ ] Ensure clean system communication\n- [ ] **FINAL TEST**: Complete game functionality\n\n---\n\n### **STEP 20: Final Architecture Validation (CRITICAL)**\n**Objective**: Validate complete modular architecture\n**Target**: Clean, maintainable, testable codebase\n\n**Validation checklist:**\n- [ ] ‚úÖ All systems under 200 lines\n- [ ] ‚úÖ Single responsibility per system\n- [ ] ‚úÖ Clean interfaces between systems\n- [ ] ‚úÖ 100% functionality preserved\n- [ ] ‚úÖ Easy to test and maintain\n- [ ] ‚úÖ Clear system boundaries\n\n---\n\n## üìÅ PROPOSED FINAL ARCHITECTURE\n\n```\nSKETCH/\n‚îú‚îÄ‚îÄ main_game.gd              # <200 lines - Pure coordinator\n‚îú‚îÄ‚îÄ main_game.tscn            # Main scene\n‚îú‚îÄ‚îÄ project.godot             # Project config\n‚îú‚îÄ‚îÄ README.md                 # Documentation\n‚îú‚îÄ‚îÄ data/                     # Game data\n‚îÇ   ‚îú‚îÄ‚îÄ constants.gd         # Constants\n‚îÇ   ‚îî‚îÄ‚îÄ game_state.gd        # Shared state\n‚îî‚îÄ‚îÄ systems/                  # Modular systems\n    ‚îú‚îÄ‚îÄ core/                 # Core systems\n    ‚îÇ   ‚îú‚îÄ‚îÄ game_manager.gd   # <150 lines - Core coordination\n    ‚îÇ   ‚îú‚îÄ‚îÄ turn_manager.gd   # Turn and player management\n    ‚îÇ   ‚îú‚îÄ‚îÄ state_manager.gd  # State coordination\n    ‚îÇ   ‚îî‚îÄ‚îÄ event_manager.gd  # Signal coordination\n    ‚îú‚îÄ‚îÄ grid/                 # Grid systems\n    ‚îÇ   ‚îú‚îÄ‚îÄ hex_grid_system.gd # Grid generation\n    ‚îÇ   ‚îú‚îÄ‚îÄ terrain_system.gd  # Terrain management\n    ‚îÇ   ‚îî‚îÄ‚îÄ visibility_system.gd # Fog of war\n    ‚îú‚îÄ‚îÄ units/                # Unit systems\n    ‚îÇ   ‚îú‚îÄ‚îÄ unit_state_system.gd # Unit state\n    ‚îÇ   ‚îú‚îÄ‚îÄ unit_movement_system.gd # Movement\n    ‚îÇ   ‚îî‚îÄ‚îÄ unit_interaction_system.gd # Interactions\n    ‚îú‚îÄ‚îÄ domains/              # Domain systems\n    ‚îÇ   ‚îú‚îÄ‚îÄ domain_system.gd  # Domain management\n    ‚îÇ   ‚îî‚îÄ‚îÄ power_system.gd   # Power economy\n    ‚îú‚îÄ‚îÄ ui/                   # UI systems\n    ‚îÇ   ‚îú‚îÄ‚îÄ label_manager.gd  # Label management\n    ‚îÇ   ‚îú‚îÄ‚îÄ button_manager.gd # Button management\n    ‚îÇ   ‚îî‚îÄ‚îÄ hud_manager.gd    # HUD display\n    ‚îú‚îÄ‚îÄ rendering/            # Rendering systems\n    ‚îÇ   ‚îú‚îÄ‚îÄ grid_renderer.gd  # Grid rendering\n    ‚îÇ   ‚îú‚îÄ‚îÄ unit_renderer.gd  # Unit rendering\n    ‚îÇ   ‚îî‚îÄ‚îÄ effect_renderer.gd # Effects\n    ‚îî‚îÄ‚îÄ input/                # Input systems\n        ‚îú‚îÄ‚îÄ input_system.gd   # Input handling\n        ‚îî‚îÄ‚îÄ movement_system.gd # Movement validation\n```\n\n---\n\n## üîç SUCCESS CRITERIA\n\n### **Per-Step Validation:**\n- [ ] ‚úÖ All existing functionality preserved\n- [ ] ‚úÖ No visual regressions\n- [ ] ‚úÖ Performance maintained or improved\n- [ ] ‚úÖ Code is more readable and maintainable\n- [ ] ‚úÖ Systems are properly decoupled\n\n### **Final Architecture Goals:**\n- **üéØ Target**: 20+ focused systems, each <200 lines\n- **üéØ Maintainability**: Easy to understand and modify\n- **üéØ Testability**: Each system can be tested independently\n- **üéØ Extensibility**: Easy to add new features\n- **üéØ Performance**: No degradation from modularization\n\n---\n\n## üö® RISK MITIGATION\n\n### **High-Risk Steps (10, 11, 13, 15):**\n- Create comprehensive backups before each step\n- Test thoroughly after each extraction\n- Maintain fallback mechanisms\n- Validate all critical game mechanics\n\n### **Rollback Strategy:**\n- Backup before each step: `cp main_game.gd main_game_step_X.gd`\n- Git commits after successful steps\n- Immediate rollback if functionality breaks\n\n---\n\n## ‚ö° IMPLEMENTATION START\n\n**Next step**: Execute STEP 10 - Extract VisibilitySystem\n**Command**: Begin with visibility system extraction from main_game.gd\n\n**Ready to begin Phase 2 refactoring!** üöÄ"